---
layout: post
title: Implementations of Affinity in R, Hadoop Mapreduce and Spark
comments: true
---

Affinity analysis is a techinque that discovers co-occurence relationships among activities performed by specific individuals or groups. In retail it is used to perform basket analysis.
Basket analysis may tell a retailer that customers often purchases shampooo and conditioner together. [1]

This blog tries to implement this analysis using several popular techniques, R, Scala & Scalding in Apache Hadoop, and Scala & Apache Spark. The idea can also be implemented in other
techinques such as Java Mapreduce, Python, etc.

Let's look at the problem below.

## Problem
The sales data are recorded in a csv file. There are three fields, orderid, product and quantity. We will find out the quantity that every groups of product are purchased together (same order).
A small sample data are listed.

```
sales.csv

orderid, product, quantity -- Header not included

2,orange,5
2,grape,5
1,orange,6
1,peach,7
2,apple,3
2,peach,4
3,apple,3
3,peach,5
2,orange,6
1,grape,4
```

## Algorithms
We are going to use the Split-Apply-Combine method to solve the problem.
Split-Apply-Combine is a common data manipulation which has three phases:
* Splitting data by the value of one or more variables
* Applying a function to each chunk of data independently
* Combining the data back into one piece

For our task, 

* Split the sales data by orderid. Create a list of orderid-> (product, quantity)
* Calculate all the product combinations and their quantities in every order. Create (product group, quantity) list.
* Combine all the (product group, quantity) among all the order and sum up by grouping on the product groups. This gives the final
(product group, quantity) list.

## R Implementation

In R, there are many ways and packages that can do split-apply-combine. Here, we use split, lapply and aggregate functions. The comments in the code have clearly explained the algorithms.

```r
## Affinity.R
## Calculate affinity from a sales file for n-product group
##
affinityR <- function(fileName,n=2) {
  
  ## This function creates all the n-product combinations in an order.
  ## For every n-product group, sort the product in order, calculate  
  ## the quantity.
  ##
  combinations <- function(df,n) {
    ## Only calculate for orders having n and more products
    if( nrow(df) >=n ) {
      ## Create all the possible n-product group
      t1 <- combn(split(df[,2:3], df["product"]),n)
      
      t2 <- do.call(rbind.data.frame,lapply(1:ncol(t1), function(x) {
        p <- sapply(1:n, function(y) t1[[y,x]][["product"]] )
        c( sort(p), list( prod( sapply(1:n, function(z) t1[[z,x]][["quantity"]]) 
                                )))
      } ) )
      names(t2) <- c(sapply(1:n, function(x) paste("product", x, sep="")), 
                     "quantity")
      t2
    }
    else
      list()
  }
  
  ## Read data
  data <- read.csv(fileName, colClasses=c("integer", "character", "integer"), 
                   header=FALSE)
  names(data) <- c("orderid","product","quantity")
  
  ## Group by orderid and quantity to ensure one product only occurs once in a 
  ## single orderid.
  ## This step can be bypassed if the original data has satisfied this 
  ## requirement.
  d1 <- aggregate(data$quantity, by=list(data$orderid, data$product), FUN=sum)
  names(d1) <- c("orderid","product","quantity")
  
  ## Split by orderid and then apply the combinations function on each group
  d2<- do.call(rbind.data.frame, lapply(split(d1, d1["orderid"]), combinations, 
    n=n))
  
  ## Sum up all groups 
  d3 <- aggregate( d2$quantity, by=d2[,sapply(1:n, function(x) paste("product", 
    x, sep=""))], FUN=sum)
  
  names(d3)[ length(names(d3)) ] <- "quantity"
  
  ## Output
  d3[ with(d3, order(-quantity)), ]
}
```

In the codes, R function split() is used to split the data. Then function sapply() is used to apply the combinations() UDF to create all product groups in 
an order. At the end, R function aggregate() is called combine to the results.

Some results:

```
> source('C:/Users/yhuang/git/blog/affinity/workspace/AffinityR/affinity.R')
> affinityR("C:/Users/yhuang/git/blog/affinity/workspace/data/sales.csv", 2)
  product1 product2 quantity
4   orange    peach       86
1    grape   orange       79
3    grape    peach       48
2    apple   orange       33
5    apple    peach       27
6    apple    grape       15
> affinityR("C:/Users/yhuang/git/blog/affinity/workspace/data/sales.csv", 3)
  product1 product2 product3 quantity
1    grape   orange    peach      388
4    apple    grape   orange      165
2    apple   orange    peach      132
3    apple    grape    peach       60
>
```

## References:
[1] Wikipedia http://en.wikipedia.org/wiki/Affinity_analysis

{% include twitter_plug.html %}
